"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(f,g){for(var k,j=0;j<g.length;j++)k=g[j],k.enumerable=k.enumerable||!1,k.configurable=!0,"value"in k&&(k.writable=!0),Object.defineProperty(f,k.key,k)}return function(f,g,j){return g&&e(f.prototype,g),j&&e(f,j),f}}();function _classCallCheck(e,f){if(!(e instanceof f))throw new TypeError("Cannot call a class as a function")}(function(e,f){var j=Symbol("loop"),k=Symbol("init"),l=e.requestAnimationFrame||e.webkitRequestAnimationFrame,m=function(){function q(r){var s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,q),this.save=[],this.canvas=r,this.cxt=r.getContext("2d"),this.width=0,this.height=0,this.rows={slide:[],top:[],bottom:[]},this.filters=[],this.leftTime=s.leftTime||2e3,this.space=s.space||10,this.unitHeight=0,this.rowNum=0,this.startIndex=0,this.looped=!1,this.fps=document.querySelector(".fps"),this.changeStyle(s)}return _createClass(q,[{key:"add",value:function add(r){r&&(this.looped&&this.countWidth([r]),this.filter(r),this.save.push(r))}},{key:"clear",value:function clear(){this.save=[],this.startIndex=0}},{key:"pause",value:function pause(){this.paused=!0}},{key:"run",value:function run(){this.paused=!1}},{key:"addFilter",value:function addFilter(r,s){return r&&s&&void this.filters.push({key:r,value:s})}},{key:"filter",value:function filter(r){var s=this.filters,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var v,z,u=s[Symbol.iterator]();!(_iteratorNormalCompletion=(v=u.next()).done);_iteratorNormalCompletion=!0)if(z=v.value,r[z.key].includes(z.value))return r.hide=!0,!1}catch(A){_didIteratorError=!0,_iteratorError=A}finally{try{!_iteratorNormalCompletion&&u.return&&u.return()}finally{if(_didIteratorError)throw _iteratorError}}}},{key:"clearRect",value:function clearRect(){this.cxt.clearRect(0,0,this.width,this.height)}},{key:"font",value:function font(){this.globalFont=this.globalStyle+" "+this.globalWeight+" "+this.globalSize+" "+this.globalFamily}},{key:"changeStyle",value:function changeStyle(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.globalSize=r.fontSize||this.globalSize||"24px",this.globalFamily=r.fontFamily||this.globalFamily||"\u5FAE\u8F6F\u96C5\u9ED1",this.globalStyle=r.fontStyle||this.globalStyle||"normal",this.globalWeight=r.fontWeight||this.globalWeight||"normal",this.globalColor=r.fontColor||this.globalColor||"#66ccff",this.globalChanged=!0}},{key:"initStyle",value:function initStyle(r){this.globalChanged=!1,this.font(),r.font=this.globalFont,r.textBaseline="middle",r.fillStyle=this.globalColor}},{key:"update",value:function update(r,s,u){this.fps.innerHTML=1e3/u>>0;var _ref=[this.save,this.cxt],v=_ref[0],z=_ref[1];if(this.globalChanged&&this.initStyle(z),this.looped||this.countWidth(v),this.paused)return!1;this.refresh(v);var _ref2=[this.startIndex],A=_ref2[0],B=_ref2[1];for(z.clearRect(0,0,r,s);B=v[A++];)this.step(B,u),this.draw(B,z),this.recovery(B,r)}},{key:"reset",value:function reset(){for(var A=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,_ref3=[this.save,this.width,this.leftTime,A],r=_ref3[0],s=_ref3[1],u=_ref3[2],v=_ref3[3],z=_ref3[4];z=r[v++];)"slide"==z.type?(z.x=s,z.rowRid=!1):z.leftTime=u,z.recovery=!1;this.startIndex=A}},{key:"getSize",value:function getSize(){this.width=this.canvas.width,this.height=this.canvas.height,this.speedScale=this.width/600,this.deleteRow(),this.countRows(),this.globalChanged=!0}},{key:"deleteRow",value:function deleteRow(){for(var _ref4=[this.save,0],r=_ref4[0],s=_ref4[1],u=_ref4[2];u=r[s++];)u.row=null}},{key:"countRows",value:function countRows(){var u=parseInt(this.globalSize)+this.space,_ref5=[(this.height-20)/u>>0,this.rows],r=_ref5[0],s=_ref5[1],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var B,C,A=Object.keys(s)[Symbol.iterator]();!(_iteratorNormalCompletion2=(B=A.next()).done);_iteratorNormalCompletion2=!0)C=B.value,s[C]=[]}catch(D){_didIteratorError2=!0,_iteratorError2=D}finally{try{!_iteratorNormalCompletion2&&A.return&&A.return()}finally{if(_didIteratorError2)throw _iteratorError2}}for(var z,v=0;v<r;v++)z={y:u*v+20},s.slide.push(z),v>=r/2?s.bottom.push(z):s.top.push(z);this.unitHeight=u,this.rowNum=r}},{key:"getRow",value:function getRow(r){if(r.row)return r.row;var _ref6=[this.rows,r.type],s=_ref6[0],u=_ref6[1],v="bottom"==u?s[u].pop():s[u].shift(),z=this["getRow_"+u]();return v||z}},{key:"getRow_bottom",value:function getRow_bottom(){return{y:20+this.unitHeight*(f.random()*this.rowNum/2+this.rowNum/2<<0),speedChange:!1,tempItem:!0}}},{key:"getRow_slide",value:function getRow_slide(){return{y:20+this.unitHeight*(f.random()*this.rowNum<<0),speedChange:!0,tempItem:!0}}},{key:"getRow_top",value:function getRow_top(){return{y:20+this.unitHeight*(f.random()*this.rowNum/2<<0),speedChange:!1,tempItem:!0}}},{key:"countWidth",value:function countWidth(r){var z=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.cxt;this.looped=!0;for(var A,_ref7=[this.width,0],s=_ref7[0],u=_ref7[1],v=_ref7[2];v=r[u++];)A=z.measureText(v.text).width>>0,v.width=A,v.x=s+(30*f.random()>>0),v.speed=2,"slide"!=v.type&&(v.x=(s-A)/2,v.leftTime=this.leftTime,v.speed=0)}},{key:"updateStyle",value:function updateStyle(r,s){s.font=this.globalStyle+" "+this.globalWeight+" "+r.globalSize+" "+this.globalFamily,s.fillStyle=r.color||this.globalColor}},{key:"step",value:function step(r,s){var u=this.getRow(r);u.speedChange&&(u.speedChange=!1,r.speed+=2*f.random()+1>>0);var v=r.speed*this.speedScale*s/16>>0;r.leftTime?r.leftTime-=s:"",r.x-=v,r.y=r.y||u.y,r.row=u}},{key:"draw",value:function draw(r,s){return r.recovery||r.hide?!1:void(s.save(),r.change&&this.updateStyle(r,s),s.fillText(r.text,r.x,r.y),s.restore())}},{key:"recovery",value:function recovery(r,s){return"slide"==r.type?(r.recovery=this.recoverySlide(r,s),!1):void(r.recovery=this.recoveryStatic(r))}},{key:"recoverySlide",value:function recoverySlide(r,s){var _ref8=[r.x,r.width],u=_ref8[0],v=_ref8[1];return r.rowRid||!(u+v<s)||r.row.tempItem||(this.rows[r.type].unshift(r.row),r.rowRid=!0),!(u>-v)}},{key:"recoveryStatic",value:function recoveryStatic(r){if(0<r.leftTime)return!1;var s=r.type;return r.row.tempItem||(this.rows[s].unshift(r.row),r.row=null),!0}},{key:"refresh",value:function refresh(r){var _ref9=[this.startIndex,,this.rows],s=_ref9[0],u=_ref9[1],v=_ref9[2],_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var A,B,z=Object.keys(v)[Symbol.iterator]();!(_iteratorNormalCompletion3=(A=z.next()).done);_iteratorNormalCompletion3=!0)B=A.value,v[B].sort(function(C,D){return C.y-D.y})}catch(C){_didIteratorError3=!0,_iteratorError3=C}finally{try{!_iteratorNormalCompletion3&&z.return&&z.return()}finally{if(_didIteratorError3)throw _iteratorError3}}for(;u=r[s++];){if(!u.recovery)return!1;this.startIndex=s,u.row=null}}}]),q}(),n=function(){function q(v){var z=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,q),this.canvas=v,this.cxt=v.getContext("2d"),this.enable=z.enable||!0,this.startIndex=0,this.save=[]}return _createClass(q,[{key:"add",value:function add(v){if(!v||"object"!=("undefined"==typeof v?"undefined":_typeof(v)))return!1;for(var _ref10=[v.steps,0],z=_ref10[0],A=_ref10[1],B=_ref10[2];B=z[A++];)this.initStep(B);this.save.push(v)}},{key:"clear",value:function clear(){this.save=[],this.startIndex=0}},{key:"reset",value:function reset(v){for(var _ref11=[this.save],z=_ref11[0],A=_ref11[1];A=z[v++];)A.hide=!1}},{key:"pause",value:function pause(){this.paused=!0}},{key:"run",value:function run(){this.paused=!1}},{key:"enableEffect",value:function enableEffect(){this.enable=!0}},{key:"disableEffect",value:function disableEffect(){this.enable=!1}},{key:"initStep",value:function initStep(v){v.scaleStartX=v.scaleStartX||1,v.scaleStartY=v.scaleStartY||1,v.scaleEndX=v.scaleEndX||1,v.scaleEndY=v.scaleEndY||1,v.rotateEnd=v.rotateEnd||0,v.rotateStart=v.rotateStart||0,v.endX=v.endX||0,v.startX=v.startX||0,v.endY=v.endY||0,v.startY=v.startY||0,v.skewStartX=v.skewStartX||0,v.skewStartY=v.skewStartY||0,v.skewEndX=v.skewEndX||0,v.skewEndY=v.skewEndY||0,v.pastTime=v.pastTime||0,v.duration=v.duration||0,v.scaleDistX=v.scaleEndX-v.scaleStartX,v.scaleDistY=v.scaleEndY-v.scaleStartY,v.rotateDist=v.rotateEnd-v.rotateStart,v.distX=v.points?v.distX||0:v.endX-v.startX,v.distY=v.points?v.distY||0:v.endY-v.startY,v.skewDistX=v.skewEndX-v.skewStartX,v.skewDistY=v.skewEndY-v.skewStartY}},{key:"getSize",value:function getSize(){this.width=this.canvas.width,this.height=this.canvas.height}},{key:"clearRect",value:function clearRect(){this.cxt.clearRect(0,0,this.width,this.height)}},{key:"update",value:function update(v,z,A){if(this.paused)return!1;var _ref12=[this.canvas,this.cxt],B=_ref12[0],C=_ref12[1];if(C.clearRect(0,0,v,z),!this.enable)return!1;for(var _ref13=[this.startIndex,this.save],D=_ref13[0],E=_ref13[1],F=_ref13[2];F=E[D++];)if(!F.hide){var I=F.steps,J=I[F.currentIndex];this.step(F,J,A),this.draw(F,J,C),this.recovery(F,J)}}},{key:"step",value:function step(v,z,A){z.pastTime+=A;var _ref14=[z.type||"linear",z.pastTime,z.duration],B=_ref14[0],C=_ref14[1],D=_ref14[2];"polygon"==v.type&&this.stepCheckPolygon(z,v),z.x=this.Tween(B,C,z.startX,z.distX,D),z.y=this.Tween(B,C,z.startY,z.distY,D),z.scaleX=this.Tween(B,C,z.scaleStartX,z.scaleDistX,D),z.scaleY=this.Tween(B,C,z.scaleStartY,z.scaleDistY,D),z.rotate=this.Tween(B,C,z.rotateStart,z.rotateDist,D),z.skewX=this.Tween(B,C,z.skewStartX,z.skewDistX,D),z.skewY=this.Tween(B,C,z.skewStartY,z.skewDistY,D)}},{key:"stepCheckPolygon",value:function stepCheckPolygon(v,z){var A=z.currentIndex;if(0==A){for(var B=0,C=0,D=v.points.concat([])||[],E=0,_ref15=[0],F=_ref15[0],G=_ref15[1];G=D[F++];)B+=G.x,C+=G.y,E++;if(0>=E)return!1;v.startX=B/E,v.startY=C/E,v.firstPoint=v.points.concat([]).shift()}else if(!v.points){var H=z.steps[A-1];v.startX=H.x,v.startY=H.y,v.points=H.points,v.firstPoint=H.firstPoint}}},{key:"draw",value:function draw(v,z,A){A.save(),!this[v.type]||this[v.type](z,A,f,f.PI/180),A.restore()}},{key:"rect",value:function rect(v,z,A,B){var _ref16=[v.x,v.y,v.width,v.height],C=_ref16[0],D=_ref16[1],E=_ref16[2],F=_ref16[3],_ref17=[A.tan(v.skewX*B),A.tan(v.skewY*B)],G=_ref17[0],H=_ref17[1];z.beginPath(),z.transform(v.scaleX,G,H,v.scaleY,C+E/2,D+F/2),z.rotate(v.rotate*A.PI/180),z.rect(-E/2,-F/2,E,F),z.closePath(),z.fillStyle=v.fillStyle,z.strokeStyle=v.strokeStyle,z.fill(),z.stroke()}},{key:"text",value:function text(v,z,A,B){var C=v.fontStyle||"normal",D=v.fontWeight||"normal",E=v.fontSize||"24px",F=v.fontFamily||"\u5FAE\u8F6F\u96C5\u9ED1",G=v.text||"";z.font=C+" "+D+" "+E+" "+F;var _ref18=[v.x,v.y,z.measureText(G).width,parseInt(E)],H=_ref18[0],I=_ref18[1],J=_ref18[2],K=_ref18[3],_ref19=[A.tan(v.skewX*B),A.tan(v.skewY*B)],L=_ref19[0],M=_ref19[1];z.transform(v.scaleX,L,M,v.scaleY,H+J/2,I+K/2),z.rotate(v.rotate*A.PI/180),z.fillStyle=v.fillStyle,z.strokeStyle=v.strokeStyle,z.fillText(G,-J/2,-K/2),z.strokeText(G,-J/2,-K/2)}},{key:"polygon",value:function polygon(v,z,A,B){var J=v.points,_ref20=[v.x,v.y,v.firstPoint],C=_ref20[0],D=_ref20[1],E=_ref20[2],_ref21=[A.tan(v.skewX*B),A.tan(v.skewY*B)],F=_ref21[0],G=_ref21[1];z.beginPath(),z.transform(v.scaleX,F,G,v.scaleY,C,D),z.rotate(v.rotate*A.PI/180),z.fillStyle=v.fillStyle,z.strokeStyle=v.strokeStyle,z.moveTo(E.x-C,E.y-D);for(var _ref22=[0],H=_ref22[0],I=_ref22[1];I=J[H++];)z.lineTo(I.x-C,I.y-D);z.closePath(),z.fill(),z.stroke()}},{key:"recovery",value:function recovery(v,z){z.pastTime>=z.duration&&(v.currentIndex++,z.pastTime=0),v.steps[v.currentIndex]||(v.hide=!0,v.currentIndex=0)}},{key:"Tween",value:function Tween(v){for(var C={linear:function linear(D,E,F,G){return F*D/G+E},easeIn:function easeIn(D,E,F,G){return F*(D/=G)*D+E},easeOut:function easeOut(D,E,F,G){return-F*(D/=G)*(D-2)+E},easeInOut:function easeInOut(D,E,F,G){return 1>(D/=G/2)?F/2*D*D+E:-F/2*(--D*(D-2)-1)+E}},A=arguments.length,z=Array(1<A?A-1:0),B=1;B<A;B++)z[B-1]=arguments[B];return!!C[v]&&C[v].apply(C,z)}}]),q}(),o=function(){function q(r){var s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(_classCallCheck(this,q),!r)throw new Error("\u6CA1\u6709\u8BBE\u7F6E\u6B63\u786E\u7684wrapper");this.wrapper=r,this.width=r.clientWidth,this.height=r.clientHeight,this.canvas=document.createElement("canvas"),this.canvas2=document.createElement("canvas"),this.normal=new m(this.canvas,s),this.effect=new n(this.canvas2,s),this.name=s.name||"",this.drawing=s.auto||!1,this.startTime=new Date().getTime(),this[k](),this[j]()}return _createClass(q,[{key:k,value:function value(){this.canvas.style.cssText="position:absolute;z-index:100;top:0px;left:0px;",this.canvas2.style.cssText="position:absolute;z-index:101;top:0px;left:0px;",this.setSize(),this.wrapper.appendChild(this.canvas),this.wrapper.appendChild(this.canvas2)}},{key:j,value:function value(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.normal,C=this,s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.effect,u=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this.startTime,v=new Date().getTime();if(!this.drawing)return r.clearRect(),s.clearRect(),!1;var _ref23=[this.width,this.height,v-u],z=_ref23[0],A=_ref23[1],B=_ref23[2];r.update(z,A,B),s.update(z,A,B),l(function(){C[j](r,s,v)})}},{key:"inputData",value:function inputData(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return"object"==("undefined"==typeof r?"undefined":_typeof(r))&&r.type&&void this.normal.add(r)}},{key:"inputEffect",value:function inputEffect(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return"object"==("undefined"==typeof r?"undefined":_typeof(r))&&r.type&&r.steps&&void this.effect.add(r)}},{key:"clear",value:function clear(){this.normal.clear(),this.effect.clear()}},{key:"reset",value:function reset(r){this.normal.reset(r),this.effect.reset(r)}},{key:"pause",value:function pause(){this.normal.pause(),this.effect.pause()}},{key:"run",value:function run(){this.normal.run(),this.effect.run()}},{key:"addFilter",value:function addFilter(r,s){this.normal.addFilter(r,s)}},{key:"disableEffect",value:function disableEffect(){this.effect.disableEffect()}},{key:"enableEffect",value:function enableEffect(){this.effect.enableEffect()}},{key:"setSize",value:function setSize(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.width,s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.height;return!Number.isInteger(r)||0>r||!Number.isInteger(s)||0>s?!1:void(this.width=r,this.height=s,this.canvas.width=r,this.canvas.height=s,this.canvas2.width=r,this.canvas2.height=s,this.normal.getSize(),this.effect.getSize())}},{key:"getSize",value:function getSize(){return{width:this.width,height:this.height}}},{key:"changeStyle",value:function changeStyle(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.normal.changeStyle(r)}},{key:"start",value:function start(){return!this.drawing&&void(this.drawing=!0,this[j]())}},{key:"stop",value:function stop(){this.drawing=!1}}]),q}(),p=function(q,r){var s=new o(q,r);return{start:s.start.bind(s),stop:s.stop.bind(s),changeStyle:s.changeStyle.bind(s),setSize:s.setSize.bind(s),inputData:s.inputData.bind(s),inputEffect:s.inputEffect.bind(s),clear:s.clear.bind(s),reset:s.reset.bind(s),pause:s.pause.bind(s),run:s.run.bind(s),addFilter:s.addFilter.bind(s),disableEffect:s.disableEffect.bind(s),enableEffect:s.enableEffect.bind(s),getSize:s.getSize.bind(s)}};"undefined"!=typeof module&&module.exports?module.exports=p:"function"==typeof define&&define.amd?define(function(){return p}):e.DanMuer=p})(window,Math);