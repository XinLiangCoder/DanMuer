(function(e,f){const j=Symbol("loop"),k=Symbol("init"),l=e.requestAnimationFrame||e.webkitRequestAnimationFrame;class m{constructor(q,r={}){this.save=[],this.canvas=q,this.cxt=q.getContext("2d"),this.width=0,this.height=0,this.rows={slide:[],top:[],bottom:[]},this.filters=[],this.leftTime=r.leftTime||2e3,this.space=r.space||10,this.unitHeight=0,this.rowNum=0,this.startIndex=0,this.looped=!1,this.fps=document.querySelector(".fps"),this.changeStyle(r)}add(q){q&&(this.looped&&this.countWidth([q]),this.filter(q),this.save.push(q))}clear(){this.save=[],this.startIndex=0}pause(){this.paused=!0}run(){this.paused=!1}addFilter(q,r){return q&&r&&void this.filters.push({key:q,value:r})}filter(q){let r=this.filters;for(let s of r)if(q[s.key].includes(s.value))return q.hide=!0,!1}clearRect(){this.cxt.clearRect(0,0,this.width,this.height)}font(){this.globalFont=this.globalStyle+" "+this.globalWeight+" "+this.globalSize+" "+this.globalFamily}changeStyle(q={}){this.globalSize=q.fontSize||this.globalSize||"24px",this.globalFamily=q.fontFamily||this.globalFamily||"\u5FAE\u8F6F\u96C5\u9ED1",this.globalStyle=q.fontStyle||this.globalStyle||"normal",this.globalWeight=q.fontWeight||this.globalWeight||"normal",this.globalColor=q.fontColor||this.globalColor||"#66ccff",this.globalChanged=!0}initStyle(q){this.globalChanged=!1,this.font(),q.font=this.globalFont,q.textBaseline="middle",q.fillStyle=this.globalColor}update(q,r,s){this.fps.innerHTML=1e3/s>>0;let[u,v]=[this.save,this.cxt];if(this.globalChanged&&this.initStyle(v),this.looped||this.countWidth(u),this.paused)return!1;this.refresh(u);let[z,A]=[this.startIndex];for(v.clearRect(0,0,q,r);A=u[z++];)this.step(A,s),this.draw(A,v),this.recovery(A,q)}reset(q=0){for(let[r,s,u,v,z]=[this.save,this.width,this.leftTime,q];z=r[v++];)"slide"==z.type?(z.x=s,z.rowRid=!1):z.leftTime=u,z.recovery=!1;this.startIndex=q}getSize(){this.width=this.canvas.width,this.height=this.canvas.height,this.speedScale=this.width/600,this.deleteRow(),this.countRows(),this.globalChanged=!0}deleteRow(){for(let[q,r,s]=[this.save,0];s=q[r++];)s.row=null}countRows(){let q=parseInt(this.globalSize)+this.space,[r,s]=[(this.height-20)/q>>0,this.rows];for(let u of Object.keys(s))s[u]=[];for(let v,u=0;u<r;u++)v={y:q*u+20},s.slide.push(v),u>=r/2?s.bottom.push(v):s.top.push(v);this.unitHeight=q,this.rowNum=r}getRow(q){if(q.row)return q.row;const[r,s]=[this.rows,q.type],u="bottom"==s?r[s].pop():r[s].shift(),v=this["getRow_"+s]();return u||v}getRow_bottom(){return{y:20+this.unitHeight*(f.random()*this.rowNum/2+this.rowNum/2<<0),speedChange:!1,tempItem:!0}}getRow_slide(){return{y:20+this.unitHeight*(f.random()*this.rowNum<<0),speedChange:!0,tempItem:!0}}getRow_top(){return{y:20+this.unitHeight*(f.random()*this.rowNum/2<<0),speedChange:!1,tempItem:!0}}countWidth(q,r=this.cxt){this.looped=!0;for(let z,[s,u,v]=[this.width,0];v=q[u++];)z=r.measureText(v.text).width>>0,v.width=z,v.x=s+(30*f.random()>>0),v.speed=2,"slide"!=v.type&&(v.x=(s-z)/2,v.leftTime=this.leftTime,v.speed=0)}updateStyle(q,r){r.font=this.globalStyle+" "+this.globalWeight+" "+q.globalSize+" "+this.globalFamily,r.fillStyle=q.color||this.globalColor}step(q,r){let s=this.getRow(q);s.speedChange&&(s.speedChange=!1,q.speed+=2*f.random()+1>>0);let u=q.speed*this.speedScale*r/16>>0;q.leftTime?q.leftTime-=r:"",q.x-=u,q.y=q.y||s.y,q.row=s}draw(q,r){return q.recovery||q.hide?!1:void(r.save(),q.change&&this.updateStyle(q,r),r.fillText(q.text,q.x,q.y),r.restore())}recovery(q,r){return"slide"==q.type?(q.recovery=this.recoverySlide(q,r),!1):void(q.recovery=this.recoveryStatic(q))}recoverySlide(q,r){let[s,u]=[q.x,q.width];return q.rowRid||!(s+u<r)||q.row.tempItem||(this.rows[q.type].unshift(q.row),q.rowRid=!0),!(s>-u)}recoveryStatic(q){if(0<q.leftTime)return!1;let r=q.type;return q.row.tempItem||(this.rows[r].unshift(q.row),q.row=null),!0}refresh(q){let[r,s,u]=[this.startIndex,,this.rows];for(let v of Object.keys(u))u[v].sort(function(z,A){return z.y-A.y});for(;s=q[r++];){if(!s.recovery)return!1;this.startIndex=r,s.row=null}}}class n{constructor(q,r={}){this.canvas=q,this.cxt=q.getContext("2d"),this.enable=r.enable||!0,this.startIndex=0,this.save=[]}add(q){if(!q||"object"!=typeof q)return!1;for(let[r,s,u]=[q.steps,0];u=r[s++];)this.initStep(u);this.save.push(q)}clear(){this.save=[],this.startIndex=0}reset(q){for(let[r,s]=[this.save];s=r[q++];)s.hide=!1}pause(){this.paused=!0}run(){this.paused=!1}enableEffect(){this.enable=!0}disableEffect(){this.enable=!1}initStep(q){q.scaleStartX=q.scaleStartX||1,q.scaleStartY=q.scaleStartY||1,q.scaleEndX=q.scaleEndX||1,q.scaleEndY=q.scaleEndY||1,q.rotateEnd=q.rotateEnd||0,q.rotateStart=q.rotateStart||0,q.endX=q.endX||0,q.startX=q.startX||0,q.endY=q.endY||0,q.startY=q.startY||0,q.skewStartX=q.skewStartX||0,q.skewStartY=q.skewStartY||0,q.skewEndX=q.skewEndX||0,q.skewEndY=q.skewEndY||0,q.pastTime=q.pastTime||0,q.duration=q.duration||0,q.scaleDistX=q.scaleEndX-q.scaleStartX,q.scaleDistY=q.scaleEndY-q.scaleStartY,q.rotateDist=q.rotateEnd-q.rotateStart,q.distX=q.points?q.distX||0:q.endX-q.startX,q.distY=q.points?q.distY||0:q.endY-q.startY,q.skewDistX=q.skewEndX-q.skewStartX,q.skewDistY=q.skewEndY-q.skewStartY}getSize(){this.width=this.canvas.width,this.height=this.canvas.height}clearRect(){this.cxt.clearRect(0,0,this.width,this.height)}update(q,r,s){if(this.paused)return!1;let[u,v]=[this.canvas,this.cxt];if(v.clearRect(0,0,q,r),!this.enable)return!1;for(let[z,A,B]=[this.startIndex,this.save];B=A[z++];)if(!B.hide){let E=B.steps,F=E[B.currentIndex];this.step(B,F,s),this.draw(B,F,v),this.recovery(B,F)}}step(q,r,s){r.pastTime+=s;let[u,v,z]=[r.type||"linear",r.pastTime,r.duration];"polygon"==q.type&&this.stepCheckPolygon(r,q),r.x=this.Tween(u,v,r.startX,r.distX,z),r.y=this.Tween(u,v,r.startY,r.distY,z),r.scaleX=this.Tween(u,v,r.scaleStartX,r.scaleDistX,z),r.scaleY=this.Tween(u,v,r.scaleStartY,r.scaleDistY,z),r.rotate=this.Tween(u,v,r.rotateStart,r.rotateDist,z),r.skewX=this.Tween(u,v,r.skewStartX,r.skewDistX,z),r.skewY=this.Tween(u,v,r.skewStartY,r.skewDistY,z)}stepCheckPolygon(q,r){let s=r.currentIndex;if(0==s){let[u,v,z,A]=[0,0,q.points.concat([])||[],0],[B,C]=[0];for(;C=z[B++];)u+=C.x,v+=C.y,A++;if(0>=A)return!1;q.startX=u/A,q.startY=v/A,q.firstPoint=q.points.concat([]).shift()}else if(!q.points){let u=r.steps[s-1];q.startX=u.x,q.startY=u.y,q.points=u.points,q.firstPoint=u.firstPoint}}draw(q,r,s){s.save(),!this[q.type]||this[q.type](r,s,f,f.PI/180),s.restore()}rect(q,r,s,u){let[v,z,A,B]=[q.x,q.y,q.width,q.height],[C,D]=[s.tan(q.skewX*u),s.tan(q.skewY*u)];r.beginPath(),r.transform(q.scaleX,C,D,q.scaleY,v+A/2,z+B/2),r.rotate(q.rotate*s.PI/180),r.rect(-A/2,-B/2,A,B),r.closePath(),r.fillStyle=q.fillStyle,r.strokeStyle=q.strokeStyle,r.fill(),r.stroke()}text(q,r,s,u){let[v,z,A,B,C]=[q.fontStyle||"normal",q.fontWeight||"normal",q.fontSize||"24px",q.fontFamily||"\u5FAE\u8F6F\u96C5\u9ED1",q.text||""];r.font=v+" "+z+" "+A+" "+B;let[D,E,F,G]=[q.x,q.y,r.measureText(C).width,parseInt(A)],[H,I]=[s.tan(q.skewX*u),s.tan(q.skewY*u)];r.transform(q.scaleX,H,I,q.scaleY,D+F/2,E+G/2),r.rotate(q.rotate*s.PI/180),r.fillStyle=q.fillStyle,r.strokeStyle=q.strokeStyle,r.fillText(C,-F/2,-G/2),r.strokeText(C,-F/2,-G/2)}polygon(q,r,s,u){let v=q.points,[z,A,B]=[q.x,q.y,q.firstPoint],[C,D]=[s.tan(q.skewX*u),s.tan(q.skewY*u)];r.beginPath(),r.transform(q.scaleX,C,D,q.scaleY,z,A),r.rotate(q.rotate*s.PI/180),r.fillStyle=q.fillStyle,r.strokeStyle=q.strokeStyle,r.moveTo(B.x-z,B.y-A);for(let[E,F]=[0];F=v[E++];)r.lineTo(F.x-z,F.y-A);r.closePath(),r.fill(),r.stroke()}recovery(q,r){r.pastTime>=r.duration&&(q.currentIndex++,r.pastTime=0),q.steps[q.currentIndex]||(q.hide=!0,q.currentIndex=0)}Tween(q,...r){const s={linear:(u,v,z,A)=>z*u/A+v,easeIn:(u,v,z,A)=>z*(u/=A)*u+v,easeOut:(u,v,z,A)=>-z*(u/=A)*(u-2)+v,easeInOut:(u,v,z,A)=>{return 1>(u/=A/2)?z/2*u*u+v:-z/2*(--u*(u-2)-1)+v}};return!!s[q]&&s[q](...r)}}class o{constructor(q,r={}){if(!q)throw new Error("\u6CA1\u6709\u8BBE\u7F6E\u6B63\u786E\u7684wrapper");this.wrapper=q,this.width=q.clientWidth,this.height=q.clientHeight,this.canvas=document.createElement("canvas"),this.canvas2=document.createElement("canvas"),this.normal=new m(this.canvas,r),this.effect=new n(this.canvas2,r),this.name=r.name||"",this.drawing=r.auto||!1,this.startTime=new Date().getTime(),this[k](),this[j]()}[k](){this.canvas.style.cssText="position:absolute;z-index:100;top:0px;left:0px;",this.canvas2.style.cssText="position:absolute;z-index:101;top:0px;left:0px;",this.setSize(),this.wrapper.appendChild(this.canvas),this.wrapper.appendChild(this.canvas2)}[j](q=this.normal,r=this.effect,s=this.startTime){let u=new Date().getTime();if(!this.drawing)return q.clearRect(),r.clearRect(),!1;let[v,z,A]=[this.width,this.height,u-s];q.update(v,z,A),r.update(v,z,A);l(()=>{this[j](q,r,u)})}inputData(q={}){return"object"==typeof q&&q.type&&void this.normal.add(q)}inputEffect(q={}){return"object"==typeof q&&q.type&&q.steps&&void this.effect.add(q)}clear(){this.normal.clear(),this.effect.clear()}reset(q){this.normal.reset(q),this.effect.reset(q)}pause(){this.normal.pause(),this.effect.pause()}run(){this.normal.run(),this.effect.run()}addFilter(q,r){this.normal.addFilter(q,r)}disableEffect(){this.effect.disableEffect()}enableEffect(){this.effect.enableEffect()}setSize(q=this.width,r=this.height){return!Number.isInteger(q)||0>q||!Number.isInteger(r)||0>r?!1:void(this.width=q,this.height=r,this.canvas.width=q,this.canvas.height=r,this.canvas2.width=q,this.canvas2.height=r,this.normal.getSize(),this.effect.getSize())}getSize(){return{width:this.width,height:this.height}}changeStyle(q={}){this.normal.changeStyle(q)}start(){return!this.drawing&&void(this.drawing=!0,this[j]())}stop(){this.drawing=!1}}let p=function(q,r){let s=new o(q,r);return{start:s.start.bind(s),stop:s.stop.bind(s),changeStyle:s.changeStyle.bind(s),setSize:s.setSize.bind(s),inputData:s.inputData.bind(s),inputEffect:s.inputEffect.bind(s),clear:s.clear.bind(s),reset:s.reset.bind(s),pause:s.pause.bind(s),run:s.run.bind(s),addFilter:s.addFilter.bind(s),disableEffect:s.disableEffect.bind(s),enableEffect:s.enableEffect.bind(s),getSize:s.getSize.bind(s)}};"undefined"!=typeof module&&module.exports?module.exports=p:"function"==typeof define&&define.amd?define(function(){return p}):e.DanMuer=p})(window,Math);